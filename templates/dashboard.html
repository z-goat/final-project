{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block main %}

    <!-- SECTION 1: STATS CARDS -->
    <div class="row mb-4">
        <!-- Revenue Card -->
        <div class="col-md-4">
            <div class="card text-white bg-success h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title opacity-75">Projected Revenue</h6>
                    <h2 class="display-6 fw-bold">{{ total_revenue | gbp }}</h2>
                </div>
            </div>
        </div>

        <!-- Clients Card -->
        <div class="col-md-4">
            <div class="card bg-light h-100 shadow-sm border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted">Total Clients</h6>
                        <h2 class="display-6">{{ clients|length }}</h2>
                    </div>
                    <a href="/addclient" class="btn btn-outline-dark btn-sm">+ Add</a>
                </div>
            </div>
        </div>

        <!-- Projects Card -->
        <div class="col-md-4">
            <div class="card bg-light h-100 shadow-sm border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted">Active Projects</h6>
                        <h2 class="display-6">{{ projects|length }}</h2>
                    </div>
                    <a href="/addproject" class="btn btn-primary btn-sm">+ Add</a>
                </div>
            </div>
        </div>
    </div>

    <!-- SECTION 2: PROJECT BOARD -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Project Board</h3>

        <!-- Sort Buttons -->
        <div class="btn-group btn-group-sm">
            <span class="btn btn-outline-secondary disabled">Sort:</span>
            <a href="/?sort=deadline" class="btn btn-outline-secondary {% if current_sort == 'deadline' %}active{% endif %}">Deadline</a>
            <a href="/?sort=importance" class="btn btn-outline-secondary {% if current_sort == 'importance' %}active{% endif %}">Importance</a>
            <a href="/?sort=value" class="btn btn-outline-secondary {% if current_sort == 'value' %}active{% endif %}">Value</a>
        </div>
    </div>

    {% if not projects %}
        <div class="alert alert-light border text-center py-5">
            <p class="lead">No active projects.</p>
            <a href="/addproject" class="btn btn-primary">Start a Project</a>
        </div>
    {% else %}
        <div class="table-responsive shadow-sm rounded bg-white">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Imp.</th>
                        <th>Project</th>
                        <th>Client</th>
                        <th>Deadline</th>
                        <th>Value</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in projects %}
                    <tr>
                        <!-- Importance Badge -->
                        <td>
                            {% if p.importance == 'High' %}
                                <span class="badge bg-danger rounded-pill">High</span>
                            {% elif p.importance == 'Low' %}
                                <span class="badge bg-success rounded-pill">Low</span>
                            {% else %}
                                <span class="badge bg-secondary rounded-pill">Med</span>
                            {% endif %}
                        </td>

                        <!-- Project Name -->
                        <td class="fw-bold">{{ p.name }}</td>

                        <!-- Client Link -->
                        <td><a href="/client/{{ p.client_id }}" class="text-decoration-none text-dark">{{ p.client_name }}</a></td>

                        <!-- Deadline (Handle None/Null) -->
                        <td class="text-muted small">
                            {% if p.deadline %}
                                {{ p.deadline }}
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <!-- Value -->
                        <td>{{ p.value | gbp }}</td>

                        <!-- Status -->
                        <td><span class="badge border text-dark">{{ p.status }}</span></td>

                        <!-- Actions (Edit & Delete) -->
                        <td>
                            <div class="d-flex gap-2 justify-content-end">
                                <a href="/edit_project/{{ p.id }}" class="btn btn-sm btn-outline-secondary border-0">Edit</a>

                                <form action="/delete_project/{{ p.id }}" method="post" onsubmit="return confirm('Delete this project?');">
                                    <button class="btn btn-sm btn-outline-danger border-0">âœ•</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    <!-- SECTION 3: CLIENT LIST -->
    <div class="mt-5 mb-5">
        <h5 class="text-muted border-bottom pb-2">Your Clients</h5>

        {% if not clients %}
            <p class="text-muted small">No clients found.</p>
        {% else %}
            <div class="list-group list-group-flush">
                {% for c in clients %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <!-- Name & Company -->
                        <span>
                            <strong>{{ c.name }}</strong>
                            {% if c.company %}
                                <span class="text-muted small">({{ c.company }})</span>
                            {% endif %}
                        </span>

                        <!-- Buttons -->
                        <div class="d-flex gap-2">
                            <a href="/client/{{ c.id }}" class="btn btn-sm btn-light">View</a>
                            <a href="/edit_client/{{ c.id }}" class="btn btn-sm btn-outline-secondary">Edit</a>

                            <form action="/delete_client/{{ c.id }}" method="post" class="d-inline" onsubmit="return confirm('Deleting this client deletes all their projects. Sure?');">
                                <button class="btn btn-sm btn-outline-danger border-0">Del</button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

{% endblock %}
